<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>рдлрд▓ рд╕рдорд╛рддреНрдиреЗ рдЦреЗрд▓ | Catch the Fruit</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        html, body { 
            height: 100%; 
            overscroll-behavior: none;
            touch-action: manipulation;
        }
        body {
            font-family: 'Noto Sans Devanagari', system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            color: #333; 
            overflow-x: hidden;
            overflow-y: auto;
        }
        .header {
            background: rgba(0,0,0,0.8); 
            padding: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .header a { 
            color: #ffd700; 
            font-size: clamp(16px, 4vw, 20px); 
            font-weight: 700; 
            text-decoration: none; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.5); 
        }
        .container { 
            width: 100%; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 12px; 
            flex: 1;
        }
        .title { 
            text-align: center; 
            font-size: clamp(20px, 5vw, 28px); 
            font-weight: 700; 
            color: #fff; 
            padding: 10px 0; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); 
        }
        .instructions, .contact { 
            background: rgba(255,255,255,0.95); 
            border-radius: 15px; 
            padding: 15px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.2); 
            margin-bottom: 10px; 
        }
        .instructions h2 { 
            font-size: clamp(16px, 4vw, 20px); 
            color: #4a5568; 
            text-align: center; 
            margin-bottom: 8px; 
        }
        .instructions ul { 
            list-style: none; 
            color: #718096; 
            font-size: clamp(12px, 3vw, 14px); 
        }
        .instructions li { 
            margin-bottom: 6px; 
            padding-left: 18px; 
            position: relative; 
        }
        .instructions li::before { 
            content: 'ЁЯНО'; 
            position: absolute; 
            left: 0; 
            top: 0; 
        }
        .dashain-message { 
            background: linear-gradient(135deg, #ff6b6b, #ee5a24); 
            color: white; 
            text-align: center; 
            padding: 12px; 
            border-radius: 15px; 
            margin: 5px 0; 
            font-size: clamp(12px, 3vw, 14px); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 
            0%, 100% { transform: scale(1); } 
            50% { transform: scale(1.02); } 
        }

        #game-container {
            position: relative; 
            width: 100%; 
            height: clamp(420px, 60vh, 640px); 
            border-radius: 15px;
            background: linear-gradient(180deg, #87ceeb 0%, #98d8e8 80%, #4a8e4c 100%);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); 
            border: 4px solid #3b5998; 
            overflow: hidden;
            touch-action: none;
        }
        #game-area { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
        }

        .stats { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            right: 10px; 
            display: flex; 
            justify-content: space-between; 
            z-index: 200; 
        }
        .stat { 
            background: rgba(255,255,255,0.95); 
            padding: 6px 12px; 
            border-radius: 15px; 
            font-size: clamp(12px, 2.5vw, 16px); 
            font-weight: 600; 
            color: #2d3748; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        #high-score { 
            background: rgba(255,215,0,0.95); 
        }

        #game-over, #start-screen {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 300;
        }
        #game-over { 
            display: none; 
            flex-direction: column; 
            color: white; 
            text-align: center; 
            gap: 8px; 
        }
        #game-over h2 { 
            font-size: clamp(24px, 6vw, 32px); 
            margin-bottom: 8px; 
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text; 
        }
        #game-over p { 
            font-size: clamp(14px, 3.5vw, 18px); 
            opacity: 0.95; 
        }
        .play-btn, .restart-btn, .screenshot-btn, .fullscreen-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d); 
            border: none; 
            padding: 12px 24px; 
            border-radius: 25px; 
            color: white; 
            font-size: clamp(16px, 4vw, 20px); 
            font-weight: 700; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(78,205,196,0.4);
            touch-action: manipulation;
        }
        .play-btn:hover, .restart-btn:hover, .screenshot-btn:hover, .fullscreen-btn:hover { 
            transform: translateY(-4px); 
        }

        .share-buttons { 
            display: flex; 
            gap: 8px; 
            margin-top: 8px; 
        }
        .share-btn { 
            padding: 10px 18px; 
            border-radius: 20px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            color: white; 
            text-decoration: none; 
        }
        .tiktok-btn { 
            background: linear-gradient(45deg, #ff0050, #ff4d6d); 
            box-shadow: 0 4px 15px rgba(255,0,80,0.4); 
        }
        .facebook-btn { 
            background: linear-gradient(45deg, #3b5998, #4267b2); 
            box-shadow: 0 4px 15px rgba(59,89,152,0.4); 
        }

        .item {
            position: absolute; 
            width: clamp(35px, 7vw, 60px); 
            height: clamp(35px, 7vw, 60px); 
            background-size: cover; 
            background-position: center; 
            cursor: pointer; 
            border-radius: 50%; 
            transition: transform 0.08s ease; 
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
            z-index: 150; 
            user-select: none; 
            -webkit-user-select: none; 
            touch-action: none;
        }
        .item:active { 
            transform: scale(0.96); 
        }
        .apple { background-image: url('fruits_images/apple.png'); }
        .mango { background-image: url('fruits_images/mango.png'); }
        .banana { background-image: url('fruits_images/banana.png'); }
        .strawberry { background-image: url('fruits_images/strawberry.png'); }
        .grapes { background-image: url('fruits_images/grapes.png'); }
        .blueberry { background-image: url('fruits_images/blueberry.png'); }

        .splash {
            position: absolute; 
            width: 70px; 
            height: 24px; 
            background: radial-gradient(circle, rgba(255,255,255,0.75) 0%, rgba(255,255,255,0) 70%); 
            border-radius: 50%; 
            opacity: 0; 
            pointer-events: none; 
            animation: splashEffect 0.7s ease-out forwards; 
            z-index: 120;
        }
        @keyframes splashEffect { 
            0% { opacity: 0.7; transform: scale(0.5); } 
            100% { opacity: 0; transform: scale(1.5); } 
        }

        .footer { 
            text-align: center; 
            padding: 10px 0; 
            color: white; 
            font-size: clamp(10px, 2.5vw, 12px); 
        }
        .social-links { 
            display: flex; 
            justify-content: center; 
            gap: 12px; 
            margin-top: 8px; 
        }
        .social-link { 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-decoration: none; 
            color: white; 
            font-size: 18px; 
            transition: transform 0.3s ease; 
        }
        .tiktok-social { 
            background: linear-gradient(45deg, #ff0050, #ff4d6d); 
        }
        .facebook-social { 
            background: linear-gradient(45deg, #3b5998, #4267b2); 
        }
        #fullscreen-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 200;
            padding: 8px 16px;
            font-size: clamp(12px, 3vw, 16px);
        }
        @media (max-width: 768px) {
            .stats { 
                flex-direction: column; 
                gap: 8px; 
                align-items: center; 
            }
            .share-buttons { 
                flex-direction: column; 
                width: 80%; 
                margin: 0 auto; 
            }
            #game-container {
                height: clamp(360px, 50vh, 480px);
            }
            #game-container.fullscreen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                border-radius: 0;
                border: none;
                margin: 0;
                padding: 0;
                z-index: 1000;
            }
            .fullscreen #fullscreen-btn {
                bottom: 20px;
                right: 20px;
            }
            .fullscreen .header,
            .fullscreen .container > *:not(#game-container) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" target="_blank" rel="noopener">RSTECHZEN Game Zone</a>
    </div>

    <div class="container">
        <div class="dashain-message">ЁЯОЙ рд╢реБрдн рджрд╢реИрдВрдХреЛ рд╣рд╛рд░реНрджрд┐рдХ рд╢реБрднрдХрд╛рдордирд╛! рдлрд▓рд╣рд░реВ рд╕рдорд╛рддреЗрд░ рдЖрдирдиреНрдж рд▓рд┐рдиреБрд╣реЛрд╕реН! ЁЯе│</div>

        <div class="instructions">
            <h2>рдХрд╕рд░реА рдЦреЗрд▓реНрдиреЗ?</h2>
            <ul>
                <li>рдЦреЗрд▓ рд╕реБрд░реБ рдЧрд░реНрди "рдЦреЗрд▓реНрдиреБрд╣реЛрд╕реН" рдмрдЯрди рдерд┐рдЪреНрдиреБрд╣реЛрд╕реНред</li>
                <li>рдлрд▓рд╣рд░реВ (рд╕реНрдпрд╛рдЙ, рдЖрдБрдк, рдХреЗрд░рд╛, рд╕реНрдЯреНрд░рдмреЗрд░реА, рдЕрдЩреНрдЧреБрд░, рдмреНрд▓реВрдмреЗрд░реА) рдорд╛ рдЯреНрдпрд╛рдк рдЧрд░реНрдиреБрд╣реЛрд╕реН - рдкреНрд░рддреНрдпреЗрдХрд▓реЗ рез рдЕрдЩреНрдХ рдердкрд┐рдиреНрдЫред</li>
                <li>реиреж рд╡рдЯрд╛ рдлрд▓рд╣рд░реВ рдЧреБрдорд╛рдЙрдиреБ рднрдпреЛ рднрдиреЗ рдЦреЗрд▓ рд╕рдорд╛рдкреНрдд рд╣реБрдиреНрдЫред</li>
                <li>рд╕реНрдХреЛрд░ рдмрдвреНрджреИ рдЬрд╛рдБрджрд╛ рдлрд▓рд╣рд░реВ рдЫрд┐рдЯреЛ рдЭрд░реНрдЫрдиреН!</li>
            </ul>
        </div>

        <div id="game-container">
            <div id="game-area"></div>

            <div id="start-screen">
                <button class="play-btn" id="playBtn">рдЦреЗрд▓реНрдиреБрд╣реЛрд╕реН</button>
            </div>

            <div class="stats">
                <div class="stat" id="score">рд╕реНрдХреЛрд░: реж</div>
                <div class="stat" id="misses">рдЧреБрдорд╛рдПрдХрд╛: реж</div>
                <div class="stat" id="high-score">рдЙрдЪреНрдЪ рд╕реНрдХреЛрд░: реж</div>
            </div>

            <div id="game-over">
                <h2>рдЦреЗрд▓ рд╕рдорд╛рдкреНрдд!</h2>
                <p>рддрдкрд╛рдИрдВрдХреЛ рд╕реНрдХреЛрд░: <span id="final-score">реж</span></p>
                <p>рдЙрдЪреНрдЪ рд╕реНрдХреЛрд░: <span id="final-high-score">реж</span></p>
                <button class="restart-btn" id="restartBtn">рдлреЗрд░рд┐ рдЦреЗрд▓реНрдиреБрд╣реЛрд╕реН</button>
                <button class="screenshot-btn" id="screenshotBtn">рд╕реНрдХреНрд░рд┐рдирд╕рдЯ рд▓рд┐рдиреБрд╣реЛрд╕реН</button>
                <div class="share-buttons">
                    <a href="#" class="share-btn tiktok-btn" id="tiktokShare">ЁЯУ▒ рдЯрд┐рдХрдЯрдХрдорд╛ рд╕реЗрдпрд░ рдЧрд░реНрдиреБрд╣реЛрд╕реН</a>
                    <a href="#" class="share-btn facebook-btn" id="facebookShare">ЁЯУШ рдлреЗрд╕рдмреБрдХрдорд╛ рд╕реЗрдпрд░ рдЧрд░реНрдиреБрд╣реЛрд╕реН</a>
                </div>
            </div>

            <button class="fullscreen-btn" id="fullscreenBtn">рдкреВрд░реНрдг рд╕реНрдХреНрд░рд┐рди</button>
        </div>

        <h1 class="title">рдлрд▓ рд╕рдорд╛рддреНрдиреЗ рдЦреЗрд▓</h1>

        <div class="contact">
            <p>рд╕рдореНрдкрд░реНрдХ: <a href="tel:9808942229">9808942229</a> | рдЗрдореЗрд▓: <a href="mailto:rstechzen@gmail.com">rstechzen@gmail.com</a></p>
        </div>

        <div class="footer">
            <p>рд╡рд┐рдХрд╛рд╕рдХрд░реНрддрд╛: рд░рд╕реНрдЯреЗрдХрдЬреЗрди | Social ID: @rstechzen | <a href="https://rstechzen.rf.gd/" target="_blank" rel="noopener">рд╡реЗрдмрд╕рд╛рдЗрдЯ</a></p>
            <p>рдХреГрдкрдпрд╛ рдЯрд┐рдХрдЯрдХ рд░ рдлреЗрд╕рдмреБрдХрдорд╛ рд╣рд╛рдореАрд▓рд╛рдИ рдлрд▓реЛ рдЧрд░реНрдиреБрд╣реЛрд╕реН!</p>
            <div class="social-links">
                <a href="https://www.facebook.com/rstechzen" class="social-link facebook-social" target="_blank" rel="noopener" aria-label="Facebook">f</a>
                <a href="https://www.tiktok.com/@rstechzen" class="social-link tiktok-social" target="_blank" rel="noopener" aria-label="TikTok">тЩм</a>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Elements
        const gameContainer = document.getElementById('game-container');
        const gameArea = document.getElementById('game-area');
        const startScreen = document.getElementById('start-screen');
        const playBtn = document.getElementById('playBtn');
        const restartBtn = document.getElementById('restartBtn');
        const screenshotBtn = document.getElementById('screenshotBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const scoreDisplay = document.getElementById('score');
        const missesDisplay = document.getElementById('misses');
        const highScoreDisplay = document.getElementById('high-score');
        const gameOverDisplay = document.getElementById('game-over');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalHighScoreDisplay = document.getElementById('final-high-score');
        const tiktokShare = document.getElementById('tiktokShare');
        const facebookShare = document.getElementById('facebookShare');

        // State
        let score = 0;
        let misses = 0;
        let highScore = parseInt(localStorage.getItem('highScore') || '0', 10) || 0;
        let gameActive = false;
        let spawnIntervalId = null;
        let activeItems = [];
        let deviceId = localStorage.getItem('deviceId') || generateDeviceId();

        highScoreDisplay.textContent = `рдЙрдЪреНрдЪ рд╕реНрдХреЛрд░: ${highScore}`;

        // Full-screen handling
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                // Request full-screen mode
                gameContainer.requestFullscreen().then(() => {
                    gameContainer.classList.add('fullscreen');
                    fullscreenBtn.textContent = 'рдкреВрд░реНрдг рд╕реНрдХреНрд░рд┐рди рдмрдиреНрдж рдЧрд░реНрдиреБрд╣реЛрд╕реН';
                    // Lock orientation to portrait on mobile devices
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('portrait').catch(err => {
                            console.warn('Orientation lock failed:', err);
                        });
                    }
                    // Adjust game area size
                    adjustGameArea();
                }).catch(err => {
                    console.error('Fullscreen error:', err);
                    alert('рдкреВрд░реНрдг рд╕реНрдХреНрд░рд┐рди рдореЛрдбрдорд╛ рдЬрд╛рди рд╕рдХрд┐рдПрдиред');
                });
            } else {
                // Exit full-screen mode
                document.exitFullscreen().then(() => {
                    gameContainer.classList.remove('fullscreen');
                    fullscreenBtn.textContent = 'рдкреВрд░реНрдг рд╕реНрдХреНрд░рд┐рди';
                    // Unlock orientation
                    if (screen.orientation && screen.orientation.unlock) {
                        screen.orientation.unlock();
                    }
                    // Reset game area size
                    adjustGameArea();
                }).catch(err => {
                    console.error('Exit fullscreen error:', err);
                    alert('рдкреВрд░реНрдг рд╕реНрдХреНрд░рд┐рдирдмрд╛рдЯ рдмрд╛рд╣рд┐рд░ рдирд┐рд╕реНрдХрди рд╕рдХрд┐рдПрдиред');
                });
            }
        }

        // Adjust game area size on full-screen toggle
        function adjustGameArea() {
            const areaRect = gameArea.getBoundingClientRect();
            activeItems.forEach(a => {
                const item = a.el;
                if (!item || !item.parentElement) return;
                const itemRect = item.getBoundingClientRect();
                const maxX = Math.max(0, areaRect.width - itemRect.width);
                if (parseFloat(item.style.left) > maxX) {
                    item.style.left = `${maxX}px`;
                }
            });
        }

        // Update button text on fullscreen change
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                gameContainer.classList.remove('fullscreen');
                fullscreenBtn.textContent = 'рдкреВрд░реНрдг рд╕реНрдХреНрд░рд┐рди';
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            } else {
                gameContainer.classList.add('fullscreen');
                fullscreenBtn.textContent = 'рдкреВрд░реНрдг рд╕реНрдХреНрд░рд┐рди рдмрдиреНрдж рдЧрд░реНрдиреБрд╣реЛрд╕реН';
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('portrait').catch(err => {
                        console.warn('Orientation lock failed:', err);
                    });
                }
            }
            adjustGameArea();
        });

        // Generate a unique device ID
        function generateDeviceId() {
            const id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            localStorage.setItem('deviceId', id);
            return id;
        }

        // LocalStorage for high score
        function setHighScore(value) {
            localStorage.setItem('highScore', value);
        }

        // Fall speed depends on score
        function getFallSpeed() {
            if (score <= 10) return 1 + Math.random() * 1;
            if (score <= 20) return 3 + Math.random() * 2;
            if (score <= 30) return 5 + Math.random() * 2;
            return 7 + Math.random() * 2;
        }

        // Create splash
        function createSplash(x, y) {
            const splash = document.createElement('div');
            splash.className = 'splash';
            splash.style.left = `${x - 35}px`;
            splash.style.top = `${y - 10}px`;
            gameArea.appendChild(splash);
            setTimeout(() => splash.remove(), 800);
        }

        // Fruit types
        const types = ['apple', 'mango', 'banana', 'strawberry', 'grapes', 'blueberry'];

        // Create and animate an item
        function createItem() {
            if (!gameActive) return;
            const item = document.createElement('div');
            const type = types[Math.floor(Math.random() * types.length)];
            item.classList.add('item', type);

            gameArea.appendChild(item);

            const itemRect = item.getBoundingClientRect();
            const itemW = itemRect.width;
            const itemH = itemRect.height;

            const areaRect = gameArea.getBoundingClientRect();
            const maxX = Math.max(0, areaRect.width - itemW);

            const left = Math.random() * maxX;
            item.style.left = `${left}px`;
            item.style.top = `${-itemH}px`;

            const fallSpeed = getFallSpeed();

            let rafId = null;
            function fall() {
                if (!gameActive) {
                    if (item.parentElement) item.remove();
                    cancelAnimationFrame(rafId);
                    activeItems = activeItems.filter(a => a.el !== item);
                    return;
                }

                let top = parseFloat(item.style.top || 0);
                top += fallSpeed;
                item.style.top = `${top}px`;

                const bottomY = top + itemH;
                const areaHeight = gameArea.clientHeight;

                if (bottomY >= areaHeight) {
                    const splashX = left + itemW / 2;
                    const splashY = areaHeight - (itemH / 2);
                    createSplash(splashX, splashY);
                    if (item.parentElement) item.remove();
                    activeItems = activeItems.filter(a => a.el !== item);

                    if (gameActive) {
                        misses += 1;
                        missesDisplay.textContent = `рдЧреБрдорд╛рдПрдХрд╛: ${misses}`;
                        if (misses >= 20) {
                            endGame();
                        }
                    }
                    cancelAnimationFrame(rafId);
                    return;
                }

                rafId = requestAnimationFrame(fall);
            }

            rafId = requestAnimationFrame(fall);
            activeItems.push({ el: item, rafId });

            function onHit(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!gameActive) return;
                score += 1;
                if (score > highScore) {
                    highScore = score;
                    highScoreDisplay.textContent = `рдЙрдЪреНрдЪ рд╕реНрдХреЛрд░: ${highScore}`;
                    setHighScore(highScore);
                }
                scoreDisplay.textContent = `рд╕реНрдХреЛрд░: ${score}`;
                cancelAnimationFrame(rafId);
                item.removeEventListener('click', onHit);
                item.removeEventListener('touchstart', onHit);
                if (item.parentElement) item.remove();
                activeItems = activeItems.filter(a => a.el !== item);
                createSplash(left + itemW / 2, parseFloat(item.style.top) + itemH / 2);
            }

            item.addEventListener('click', onHit, { passive: false });
            item.addEventListener('touchstart', onHit, { passive: false });
        }

        // Start spawning items
        function startSpawning() {
            if (spawnIntervalId) clearInterval(spawnIntervalId);

            function computeInterval() {
                return Math.max(300, 900 - Math.floor(score * 15));
            }

            createItem();

            spawnIntervalId = setInterval(() => {
                createItem();
                const newInterval = computeInterval();
                if (newInterval !== spawnIntervalId._lastInterval) {
                    clearInterval(spawnIntervalId);
                    spawnIntervalId = setInterval(() => {
                        createItem();
                    }, newInterval);
                    spawnIntervalId._lastInterval = newInterval;
                }
            }, computeInterval());
            spawnIntervalId._lastInterval = computeInterval();
        }

        // End game
        function endGame() {
            gameActive = false;
            finalScoreDisplay.textContent = score;
            finalHighScoreDisplay.textContent = highScore;
            gameOverDisplay.style.display = 'flex';
            startScreen.style.display = 'none';

            if (spawnIntervalId) {
                clearInterval(spawnIntervalId);
                spawnIntervalId = null;
            }

            activeItems.forEach(a => {
                try { cancelAnimationFrame(a.rafId); } catch(e) {}
                if (a.el && a.el.parentElement) a.el.remove();
            });
            activeItems = [];
        }

        function restartGameUIReset() {
            gameOverDisplay.style.display = 'none';
            startScreen.style.display = 'flex';
            activeItems.forEach(a => {
                try { cancelAnimationFrame(a.rafId); } catch(e) {}
                if (a.el && a.el.parentElement) a.el.remove();
            });
            activeItems = [];
            score = 0; 
            misses = 0;
            scoreDisplay.textContent = `рд╕реНрдХреЛрд░: ${score}`;
            missesDisplay.textContent = `рдЧреБрдорд╛рдПрдХрд╛: ${misses}`;
            gameActive = false;
        }

        // Start game
        function startGame() {
            startScreen.style.display = 'none';
            gameOverDisplay.style.display = 'none';
            score = 0; 
            misses = 0;
            scoreDisplay.textContent = `рд╕реНрдХреЛрд░: ${score}`;
            missesDisplay.textContent = `рдЧреБрдорд╛рдПрдХрд╛: ${misses}`;
            gameActive = true;
            startSpawning();
        }

        // Screenshot functionality
        function takeScreenshot() {
            if (typeof html2canvas === 'undefined') {
                alert('Screenshot library not yet loaded. Try again in a moment.');
                return;
            }
            html2canvas(gameContainer).then(canvas => {
                const link = document.createElement('a');
                link.download = `рдлрд▓_рд╕рдорд╛рддреНрдиреЗ_рдЦреЗрд▓_рд╕реНрдХреЛрд░_${score}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).catch(err => {
                console.error(err);
                alert('рд╕реНрдХреНрд░рд┐рдирд╕рдЯ рд▓рд┐рди рд╕рдорд╕реНрдпрд╛ рднрдпреЛред рдХрдиреНрд╕реЛрд▓ рд╣реЗрд░реНрдиреБрд╣реЛрд╕реНред');
            });
        }

        // Share handlers
        function shareToTikTok(e) {
            e.preventDefault();
            if (navigator.share) {
                navigator.share({
                    title: `рдлрд▓ рд╕рдорд╛рддреНрдиреЗ рдЦреЗрд▓ - рд╕реНрдХреЛрд░ ${score}!`,
                    text: `рдореИрд▓реЗ рдлрд▓ рд╕рдорд╛рддреНрдиреЗ рдЦреЗрд▓рдорд╛ ${score} рд╕реНрдХреЛрд░ рдмрдирд╛рдПрдБ! рддрдкрд╛рдИрдВ рдкрдирд┐ рдЦреЗрд▓реНрдиреБрд╣реЛрд╕реН ЁЯОо`,
                    url: window.location.href
                }).catch(console.error);
            } else {
                const text = `рдлрд▓ рд╕рдорд╛рддреНрдиреЗ рдЦреЗрд▓ - рд╕реНрдХреЛрд░ ${score}! рд╢реБрдн рджрд╢реИрдВ! ЁЯОЙ\n${window.location.href}`;
                navigator.clipboard.writeText(text).then(() => alert('рдЯрд┐рдХрдЯрдХрдХреЛ рд▓рд╛рдЧрд┐ рд▓рд┐рдЩреНрдХ рдХрдкреА рднрдпреЛ! рдкреЗрд╕реНрдЯ рдЧрд░реНрдиреБрд╣реЛрд╕реНред')).catch(() => alert('рдХрдкреА рдЧрд░реНрди рд╕рдХрд┐рдПрдиред'));
            }
        }
        function shareToFacebook(e) {
            e.preventDefault();
            const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent('рдореИрд▓реЗ рдлрд▓ рд╕рдорд╛рддреНрдиреЗ рдЦреЗрд▓рдорд╛ '+score+' рд╕реНрдХреЛрд░ рдмрдирд╛рдПрдБ! рд╢реБрдн рджрд╢реИрдВ! ЁЯОЙ')}`;
            window.open(url, '_blank', 'width=600,height=400');
        }

        // Wire UI events
        playBtn.addEventListener('click', startGame, { passive: false });
        playBtn.addEventListener('touchstart', startGame, { passive: false });
        restartBtn.addEventListener('click', () => {
            restartGameUIReset();
            startGame();
        }, { passive: false });
        restartBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            restartGameUIReset();
            startGame();
        }, { passive: false });
        screenshotBtn.addEventListener('click', takeScreenshot, { passive: false });
        screenshotBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            takeScreenshot();
        }, { passive: false });
        tiktokShare.addEventListener('click', shareToTikTok, { passive: false });
        tiktokShare.addEventListener('touchstart', shareToTikTok, { passive: false });
        facebookShare.addEventListener('click', shareToFacebook, { passive: false });
        facebookShare.addEventListener('touchstart', shareToFacebook, { passive: false });
        fullscreenBtn.addEventListener('click', toggleFullScreen, { passive: false });
        fullscreenBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            toggleFullScreen();
        }, { passive: false });

        // Prevent page scrolling while touching game container
        gameContainer.addEventListener('touchstart', (e) => {
            if (e.target.classList.contains('item')) return;
            e.preventDefault();
        }, { passive: false });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (spawnIntervalId) clearInterval(spawnIntervalId);
            activeItems.forEach(a => {
                try { cancelAnimationFrame(a.rafId); } catch(e) {}
            });
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            startScreen.style.display = 'flex';
            gameOverDisplay.style.display = 'none';
            scoreDisplay.textContent = `рд╕реНрдХреЛрд░: ${score}`;
            missesDisplay.textContent = `рдЧреБрдорд╛рдПрдХрд╛: ${misses}`;
            highScoreDisplay.textContent = `рдЙрдЪреНрдЪ рд╕реНрдХреЛрд░: ${highScore}`;
        });

        // Handle window resize
        window.addEventListener('resize', adjustGameArea);
    </script>
</body>
</html>
